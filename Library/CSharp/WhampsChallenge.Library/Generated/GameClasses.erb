<%
	require 'json'

	file = nil
	File.open('../../../Library/common/contract.json', 'r') do |f|
		file = JSON.load(f)
	end
%>
// Generated file, so ReSharper-Checks are disabled.
// ReSharper disable all

using System.Threading.Tasks;
using Newtonsoft.Json;

using WhampsChallenge.Shared.Communication;
using WhampsChallenge.Shared.Extensions;

using WhampsChallenge.Library.Shared.Enums;
using WhampsChallenge.Library.Shared.Types;
using WhampsChallenge.Library.Shared.Actions;
using WhampsChallenge.Library.Shared.Events;

<% file['Levels'].each_pair do |level, leveldata| %>
namespace WhampsChallenge.Library.<%= level %> {

    using WhampsChallenge.Library.<%= level %>.Enums;
    using WhampsChallenge.Library.<%= level %>.Types;
    using WhampsChallenge.Library.<%= level %>.Actions;
    using WhampsChallenge.Library.<%= level %>.Events;

    [System.CodeDom.Compiler.GeneratedCode("Erubis", null)]
    public class Game {

        private readonly ICommunicator _communicator;
        private readonly KnownTypeJsonConverter<Event> _decoder;

        public Game(ICommunicator communicator)
        {
            _communicator = communicator;
            _decoder = new KnownTypeJsonConverter<Event>("Event") {
<%              leveldata['Events'].each_pair do |event, event_data| %>
                { "<%= event %>", typeof(<%= event %>) },
<%              end %>
            };
        }

<%      leveldata['Actions'].each_pair do |action_name, action_data| %>
        public <%= leveldata['ResultType'] %> <%= action_name %>(<%= action_data['Parameters'].map {|n, t| "#{t} #{n.downcase}"}.join(', ') %>) {
            var message = new <%= action_name %> {
<%          action_data['Parameters'].each_pair do |name, type| %>
                <%= name %> = <%= name.downcase %>,
<%          end %>
            };

            _communicator.Send(JsonConvert.SerializeObject(message));
            var json = _communicator.Receive();
            var result = JsonConvert.DeserializeObject<ActionResult>(json, _decoder);

            return result;
        }

        public async Task<<%= leveldata['ResultType'] %>> <%= action_name %>Async(<%= action_data['Parameters'].map {|n, t| "#{t} #{n.downcase}"}.join(', ') %>) {
            var message = new <%= action_name %> {
<%          action_data['Parameters'].each_pair do |name, type| %>
                <%= name %> = <%= name.downcase %>,
<%          end %>
            };

            await _communicator.SendAsync(JsonConvert.SerializeObject(message));
            
            var json = await _communicator.ReceiveAsync();
            var result = JsonConvert.DeserializeObject<ActionResult>(json, _decoder);

            return result;
        }

<%      end %>
    }
}

<% end %>
